# GitLab CI/CD é…ç½®æ–‡ä»¶
# æˆ˜åœ°è¯Šæ‰€ - Vue 3 + Rspack + TypeScript é¡¹ç›®

# å®šä¹‰æµæ°´çº¿é˜¶æ®µ
stages:
  - install
  - check
  - build

# å®šä¹‰é»˜è®¤é•œåƒ
image: node:20-alpine

# å®šä¹‰ç¼“å­˜ç­–ç•¥
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/

# å…¨å±€å‰ç½®è„šæœ¬
before_script:
  - corepack enable
  - corepack prepare pnpm@latest --activate
  - pnpm config set store-dir .pnpm-store

# ==================== é˜¶æ®µ 1: å®‰è£…ä¾èµ– ====================
install_dependencies:
  stage: install
  script:
    - echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - merge_requests
    - tags

# ==================== é˜¶æ®µ 2: ä»£ç æ£€æŸ¥ ====================
type_check:
  stage: check
  dependencies:
    - install_dependencies
  script:
    - echo "ğŸ” TypeScript ç±»å‹æ£€æŸ¥..."
    - pnpm check
  only:
    - main
    - merge_requests
    - tags

# ==================== é˜¶æ®µ 3: æ„å»ºæ£€æŸ¥ ====================
build_check:
  stage: build
  dependencies:
    - install_dependencies
  script:
    - echo "ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
    - pnpm build
    - echo "âœ… æ„å»ºæˆåŠŸ!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - merge_requests
    - tags

# ==================== å¯é€‰: ç”Ÿäº§éƒ¨ç½² ====================
# deploy_production:
#   stage: deploy
#   dependencies:
#     - build_check
#   script:
#     - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
#     # åœ¨è¿™é‡Œæ·»åŠ éƒ¨ç½²è„šæœ¬ï¼Œä¾‹å¦‚:
#     # - rsync -avz dist/ user@server:/var/www/html/
#     # - æˆ–ä½¿ç”¨å…¶ä»–éƒ¨ç½²å·¥å…·
#   only:
#     - main
#   when: manual  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
